// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------
// 1. Core Users + Authentication
// ---------------------------------------------------------

// Enums for clarity and stricter types
enum UserRole {
  INDIVIDUAL // Patient
  HOSPITAL_ADMIN // Top-level Hospital Manager
  DOCTOR // Medical Professional (Under a Hospital)
}

enum AppointmentStatus {
  PENDING // Default: request sent
  CONFIRMED
  COMPLETED
  CANCELLED
}

// The core "User" model manages secure login credentials
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String // Hashed password
  role      UserRole // Defines which profile to link to
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profile Relations (One-to-One)
  // Only one of these will be populated per user depending on role
  individualProfile IndividualProfile?
  hospitalProfile   HospitalProfile?
  doctorProfile     DoctorProfile? // If a user logs in as a Doctor

  // Shared Relations
  notifications Notification[]
}


// ---------------------------------------------------------
// 2. Individual (Patient) Models
// ---------------------------------------------------------

model IndividualProfile {
  id     String @id @default(uuid())
  
  // Link back to User (One-to-One)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Info
  firstName   String
  lastName    String
  dateOfBirth DateTime?
  gender      String? // M, F, Other
  phoneNumber String?
  address     String?

  // Medical Essentials (Optional)
  bloodGroup String? // A+, O-, etc.
  genotype   String? // AA, AS, etc.
  allergies  String? // Comma separated list or simple string

  // Relations (What belongs to a patient?)
  healthScans    HealthScan[]    // From the "Analyse" feature
  appointments   Appointment[]   // Bookings they made
  medicalReports MedicalReport[] // Reports generated for them
}

// Stores detailed biometric data from the "Scan Health" feature
model HealthScan {
  id           String            @id @default(uuid())
  
  // Owner
  individualId String
  individual   IndividualProfile @relation(fields: [individualId], references: [id], onDelete: Cascade)

  // Metrics (Nullable because scans might fail partially or be incomplete)
  heartRate        Int?    // bpm
  oxygenSaturation Int?    // %
  respirationRate  Int?    // rpm
  stressLevel      String? // "Low", "Medium", "High"
  temperature      Float?  // Celsius

  scanImageUrl String? // URL to the image used (if stored)
  aiAnalysis   String? // The "Main Insight" or overall summary generated by AI
  overallScore Int?    // 0-100 score shown in the UI circle

  createdAt DateTime @default(now())
}


// ---------------------------------------------------------
// 3. Hospital (Provider) Models
// ---------------------------------------------------------

// Admins manage the hospital entity
model HospitalProfile {
  id     String @id @default(uuid())
  
  // Link back to User (One-to-One)
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Facility Info
  name               String // Hospital Name
  registrationNumber String @unique // Official Reg Number
  address            String?
  contactEmail       String? // Public contact email
  contactPhone       String?

  // Relations
  doctors      DoctorProfile[] // Staff
  appointments Appointment[]   // All appointments at this facility
}

// Doctors work under a hospital
model DoctorProfile {
  id     String @id @default(uuid())
  
  // Link back to User (One-to-One) - Doctors need logins too!
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Employment Link
  hospitalId String
  hospital   HospitalProfile @relation(fields: [hospitalId], references: [id])

  // Professional Info
  firstName      String
  lastName       String
  specialization String  // e.g. "Cardiologist", "General Practitioner"
  licenseNumber  String?

  // Relations
  appointments   Appointment[]   // Appointments assigned to THIS doctor
  medicalReports MedicalReport[] // Reports created by THIS doctor
}


// ---------------------------------------------------------
// 4. Shared Features (Appointments, Reports, etc.)
// ---------------------------------------------------------

model Appointment {
  id String @id @default(uuid())

  // Who is booking?
  individualId String
  individual   IndividualProfile @relation(fields: [individualId], references: [id])

  // Where?
  hospitalId String
  hospital   HospitalProfile @relation(fields: [hospitalId], references: [id])

  // With whom? (Optional - might book generally with hospital first)
  doctorId String?
  doctor   DoctorProfile? @relation(fields: [doctorId], references: [id])

  // Details
  date        DateTime
  reason      String            // "Headache", "Regular Checkup"
  status      AppointmentStatus @default(PENDING)
  notes       String?           // Doctor's follow-up notes
  
  // Voice Integration
  voiceNoteUrl String? // Link to voice note if booking was via voice/AI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// The core output of the "AI Voice-to-Text Reporting" feature
model MedicalReport {
  id String @id @default(uuid())

  // Report Ownership (Patient)
  individualId String
  individual   IndividualProfile @relation(fields: [individualId], references: [id])

  // Creator (Doctor) - Optional if generated by Patient AI Scanner
  doctorId String?
  doctor   DoctorProfile? @relation(fields: [doctorId], references: [id])

  // Content
  title           String  // e.g. "Pre-Consultation Report - Feb 21"
  audioUrl        String? // Link to original voice recording (if any)
  transcript      String? // Raw Whisper text
  aiAnalysis      String? // Full structured analysis from GPT-4
  
  // Specific parsed fields for easier filtering
  chiefComplaint  String? // Extracted from AI Analysis
  diagnosis       String? // Preliminary assessment (if provider-generated)
  prescription    String? // (if provider-generated)

  createdAt DateTime @default(now())
}

// Simple Notification System
model Notification {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  message   String
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())
}
